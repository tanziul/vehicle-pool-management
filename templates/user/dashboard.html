﻿{% extends "base.html" %}
{% load static %}

{% block page_title %}Available Vehicles{% endblock %}

{% block content %}
<div class="page-wrapper">
    {% if messages %}
        <div class="container-fluid mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="content-card">

        <!-- ACTION BAR -->
        <div class="action-bar">
            <div class="text-center">
                <small class="text-muted">
                    <strong>{{ vehicles|length }}</strong> vehicle{{ vehicles|length|pluralize }} found
                </small>
            </div>
        </div>

        <!-- VEHICLE GRID -->
        <div class="row g-3">
            {% for v in vehicles %}
            <div class="col-md-4 col-lg-3">
                <div class="card border-0 shadow-sm hover-lift">
                    <div class="card-body d-flex flex-column p-3">
                        {% if v.photo %}
                            <img src="{{ v.photo.url }}"
                                 alt="{{ v.model }}"
                                 class="vehicle-photo mb-2">
                        {% else %}
                            <div class="vehicle-photo-placeholder mb-2">
                                <i class="bi bi-car-front text-muted"></i>
                            </div>
                        {% endif %}
                        <h6 class="card-title mb-2">{{ v.model }}</h6>

                        <div class="mb-3">
                            <p class="mb-1 small"><strong>Plate:</strong> <span class="text-primary fw-bold">{{ v.vehicle_number }}</span></p>
                            <p class="mb-1 small"><strong>Seats:</strong> <span class="badge bg-light text-dark">{{ v.capacity }}</span></p>
                            <p class="mb-0 small"><strong>Driver:</strong>
                                {% if v.assigned_driver %}
                                    <span class="text-success fw-bold">{{ v.assigned_driver.name }}</span>
                                {% else %}
                                    <em class="text-muted">Not Assigned</em>
                                {% endif %}
                            </p>
                        </div>

                        <div class="mt-auto">
                            <button class="btn btn-primary-gradient w-100 py-2 fw-bold" data-bs-toggle="modal" data-bs-target="#requestModal{{ v.id }}">
                                Request Trip
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-5">
                <i class="bi bi-truck display-4 text-muted mb-3"></i>
                <h5 class="text-muted">No vehicles available</h5>
                <p class="text-muted">Please check back later.</p>
            </div>
            {% endfor %}
        </div>

        <!-- REQUEST MODALS -->
        {% for v in vehicles %}
        <div class="modal fade" id="requestModal{{ v.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <form method="post" action="{% url 'request_vehicle' v.id %}">
                    {% csrf_token %}
                    <div class="modal-content border-0 shadow">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"><i class="bi bi-car-front me-2"></i>Request: {{ v.model }}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            {% if form %}
                                {% if form.non_field_errors %}
                                <div class="alert alert-danger mb-3">
                                    {{ form.non_field_errors.0 }}
                                </div>
                                {% endif %}

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Start Time *</label>
                                        {{ form.start_time }}
                                        <small class="text-danger d-block">{{ form.start_time.errors.0 }}</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">End Time *</label>
                                        {{ form.end_time }}
                                        <small class="text-danger d-block">{{ form.end_time.errors.0 }}</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Destination *</label>
                                        {{ form.destination }}
                                        <small class="text-danger d-block">{{ form.destination.errors.0 }}</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Purpose *</label>
                                        {{ form.purpose }}
                                        <small class="text-danger d-block">{{ form.purpose.errors.0 }}</small>
                                    </div>
                                </div>
                            {% else %}
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Start Time *</label>
                                        <input name="start_time" type="datetime-local" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">End Time *</label>
                                        <input name="end_time" type="datetime-local" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Destination *</label>
                                        <input name="destination" class="form-control" placeholder="e.g. Dhaka Office" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Purpose *</label>
                                        <input name="purpose" class="form-control" placeholder="e.g. Meeting" required>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit Request</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}

        <!-- AUTO OPEN MODAL ON ERROR -->
        {% if modal_vehicle_id %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var modal = new bootstrap.Modal(document.getElementById('requestModal{{ modal_vehicle_id }}'));
                modal.show();
            });
        </script>
        {% endif %}
    </div>
</div>
{% endblock %}