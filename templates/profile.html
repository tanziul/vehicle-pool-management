{% extends "base.html" %}
{% load static %}

{% block page_title %}My Profile{% endblock %}
{% block header_title %}My Profile{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="content-card profile-main-card">

        <!-- Profile Header -->
        <div class="profile-header-section">
            <div class="d-flex align-items-center gap-3">
                {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" class="profile-main-avatar"
                         alt="{{ user.get_full_name|default:user.username }}"
                         onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name={{ user.get_full_name|default:user.username|urlencode }}&background=3b82f6&color=fff&size=200'">
                {% else %}
                    <img src="https://ui-avatars.com/api/?name={{ user.get_full_name|default:user.username|urlencode }}&background=3b82f6&color=fff&size=200"
                         class="profile-main-avatar"
                         alt="{{ user.get_full_name|default:user.username }}">
                {% endif %}
                <div>
                    <h4 class="profile-main-name mb-1">{{ user.get_full_name|default:user.username }}</h4>
                    <p class="profile-main-role mb-0">{{ user.get_role_display }}</p>
                </div>
            </div>


        </div>

        <div class="profile-body">
            <!-- Info & Stats Row -->
            <div class="row g-4">
                <!-- Personal Info Card -->
                <div class="col-lg-4">
                    <div class="profile-info-card">
                        <h6 class="profile-section-heading mb-3">
                            <i class="bi bi-person-circle me-2"></i>Personal Information
                        </h6>
                        <div class="profile-info-compact">
                            <div class="info-row">
                                <span class="info-label"><i class="bi bi-envelope me-1"></i>Email</span>
                                <span class="info-value">{{ user.email|default:"Not set" }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label"><i class="bi bi-person me-1"></i>Username</span>
                                <span class="info-value">{{ user.username }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label"><i class="bi bi-shield-check me-1"></i>Role</span>
                                <span class="info-value badge bg-secondary">{{ user.get_role_display }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label"><i class="bi bi-calendar-plus me-1"></i>Joined</span>
                                <span class="info-value">{{ user.date_joined|date:"M d, Y" }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label"><i class="bi bi-clock-history me-1"></i>Last Login</span>
                                <span class="info-value">{{ user.last_login|date:"M d, Y H:i"|default:"Never" }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label"><i class="bi bi-circle-fill me-1"></i>Status</span>
                                <span class="info-value">
                                    {% if user.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Card -->
                <div class="col-lg-8">
                    <div class="profile-stats-card">
                        <h6 class="profile-section-heading mb-3">
                            <i class="bi bi-graph-up me-2"></i>My Statistics
                        </h6>
                        <div class="profile-stats-compact">
                            <div class="stat-row">
                                <div class="stat-item bg-gradient-primary">
                                    <div class="stat-number text-white">{{ total_bookings_made }}</div>
                                    <div class="stat-label text-white opacity-90">Total Bookings</div>
                                    <i class="stat-icon bi bi-calendar-check text-white opacity-75"></i>
                                </div>
                                <div class="stat-item bg-gradient-warning">
                                    <div class="stat-number text-white">{{ pending_bookings_made }}</div>
                                    <div class="stat-label text-white opacity-90">Pending</div>
                                    <i class="stat-icon bi bi-clock-history text-white opacity-75"></i>
                                </div>
                                <div class="stat-item bg-gradient-success">
                                    <div class="stat-number text-white">{{ completed_bookings_made }}</div>
                                    <div class="stat-label text-white opacity-90">Completed</div>
                                    <i class="stat-icon bi bi-check-circle text-white opacity-75"></i>
                                </div>
                                {% if user.role == 'Admin' or user.is_superuser %}
                                <div class="stat-item bg-gradient-info">
                                    <div class="stat-number text-white">{{ bookings_approved|default:0 }}</div>
                                    <div class="stat-label text-white opacity-90">Approved</div>
                                    <i class="stat-icon bi bi-check-square text-white opacity-75"></i>
                                </div>
                                <div class="stat-item stat-item-vehicles">
                                    <div class="stat-number text-white">{{ total_vehicles_managed|default:0 }}</div>
                                    <div class="stat-label text-white opacity-90">Vehicles</div>
                                    <i class="stat-icon bi bi-truck text-white opacity-75"></i>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="profile-section-heading mb-0">
                        <i class="bi bi-activity me-2"></i>Recent Bookings
                    </h6>
                    {% if user.role == 'Admin' or user.is_superuser %}
                        <a href="{% url 'admin_bookings' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye me-1"></i> View All
                        </a>
                    {% else %}
                        <a href="{% url 'user_bookings' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye me-1"></i> View All
                        </a>
                    {% endif %}
                </div>
                <div class="table-responsive profile-activity-table">
                    <table class="table data-table align-middle">
                        <thead>
                            <tr>
                                <th>Vehicle</th>
                                <th>Date & Time</th>
                                <th>Destination</th>
                                <th>Purpose</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in recent_bookings %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="vehicle-icon me-2">
                                            <i class="bi bi-truck text-primary"></i>
                                        </div>
                                        <div>
                                            <strong>{{ booking.vehicle.model }}</strong><br>
                                            <small class="text-muted">{{ booking.vehicle.vehicle_number }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {{ booking.start_time|date:"M d, Y" }}<br>
                                    <small class="text-muted">{{ booking.start_time|time:"H:i" }} - {{ booking.end_time|time:"H:i" }}</small>
                                </td>
                                <td>{{ booking.destination|truncatechars:30 }}</td>
                                <td>{{ booking.purpose|truncatechars:40 }}</td>
                                <td>
                                    <span class="status-badge
                                        {% if booking.status == 'Approved' %}status-available
                                        {% elif booking.status == 'Pending' %}status-reserved
                                        {% elif booking.status == 'Rejected' %}bg-danger text-white
                                        {% elif booking.status == 'Completed' %}bg-success text-white
                                        {% elif booking.status == 'Cancelled' %}bg-secondary text-white
                                        {% else %}status-out{% endif %}">
                                        {{ booking.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">
                                    <i class="bi bi-calendar-x display-6 mb-2"></i><br>
                                    No bookings yet
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}
