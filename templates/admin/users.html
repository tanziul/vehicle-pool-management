{% extends "base.html" %}
{% load static %}
{% block page_title %}Manage Users{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Manage Users</h2>
    <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#addUserModal">
        Add New User
    </button>
</div>

<form method="get" class="mb-4">
    <div class="input-group">
        <input type="text" name="q" class="form-control" placeholder="Search by name, username, email..." value="{{ request.GET.q|default:'' }}">
        <button class="btn btn-primary">Search</button>
        {% if request.GET.q %}
         <a href="{% url 'admin_users' %}" class="btn btn-outline-secondary ms-2">Clear</a>
        {% endif %}
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Username</th>
                <th>Role</th>
                <th>Email</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for u in users %}
            <tr {% if not u.is_active %}class="table-secondary text-muted"{% endif %}>
                <td>
                    <strong>{{ u.get_full_name|default:"—" }}</strong>
                    {% if not u.is_active %}<span class="badge bg-dark ms-2">Left</span>{% endif %}
                </td>
                <td>{{ u.username }}</td>
                <td>
                    <span class="badge {% if u.role == 'Admin' %}bg-danger{% elif u.role == 'Manager' %}bg-primary{% elif u.role == 'HR' %}bg-info{% else %}bg-secondary{% endif %}">
                        {{ u.get_role_display }}
                    </span>
                </td>
                <td>{{ u.email|default:"—" }}</td>
                <td>
                    <span class="badge bg-{% if u.is_active %}success{% else %}danger{% endif %}">
                        {% if u.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                </td>
                <td>
                    <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#edit{{ u.id }}">Edit</button>
                </td>
            </tr>

            <div class="modal fade" id="edit{{ u.id }}">
                <div class="modal-dialog">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ u.id }}">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5>Edit {{ u.get_full_name|default:u.username }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <input name="username" value="{{ u.username }}" class="form-control mb-3" required>
                                <input name="email" value="{{ u.email }}" class="form-control mb-3" type="email">
                                <input name="first_name" value="{{ u.first_name }}" class="form-control mb-3">
                                <input name="last_name" value="{{ u.last_name }}" class="form-control mb-3">
                                <input type="password" name="password" class="form-control mb-3" placeholder="New Password (optional)">
                                <select name="role" class="form-select mb-3" required>
                                    {% for val, label in ROLE_CHOICES %}
                                        <option value="{{ val }}" {% if val == u.role %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="active{{ u.id }}" {% if u.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="active{{ u.id }}">Account Active</label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" name="edit_user" class="btn btn-warning">Update</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="addUserModal">
    <div class="modal-dialog">
        <form method="post">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5>Add New User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input name="username" class="form-control mb-3" placeholder="Username" required>
                    <input type="password" name="password" class="form-control mb-3" placeholder="Password" required>
                    <input name="first_name" class="form-control mb-3" placeholder="First Name">
                    <input name="last_name" class="form-control mb-3" placeholder="Last Name">
                    <input name="email" class="form-control mb-3" placeholder="Email" type="email">
                    <select name="role" class="form-select mb-3" required>
                        <option value="">-- Select Role --</option>
                        {% for val, label in ROLE_CHOICES %}
                            <option value="{{ val }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" name="add_user" class="btn btn-success">Create User</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}